name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-agent:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - uses: actions/setup-go@v5
      with:
        go-version: '1.22'
        cache-dependency-path: wirewarp-agent/go.sum

    - name: Build agent binary (linux/amd64, static)
      working-directory: wirewarp-agent
      run: |
        SHA=$(git -C .. rev-parse --short HEAD)
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
          -ldflags "-X main.version=${SHA}" \
          -o dist/wirewarp-agent ./cmd/agent/

    - name: Commit updated binary
      if: github.ref == 'refs/heads/main'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add wirewarp-agent/dist/wirewarp-agent
        git diff --staged --quiet || git commit -m "ci: rebuild wirewarp-agent binary [skip ci]"
        git push

  build-server:
    runs-on: ubuntu-latest
    needs: build-agent
    permissions:
      contents: read
      packages: write

    steps:
    - uses: actions/checkout@v4
      with:
        ref: main  # use post-commit state so Docker image includes updated binary

    - name: Log in to GHCR
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Build the Docker image
      run: docker build . --file wirewarp-server/Dockerfile --tag ghcr.io/${{ github.repository }}:latest

    - name: Push to GHCR
      if: github.ref == 'refs/heads/main'
      run: docker push ghcr.io/${{ github.repository }}:latest
